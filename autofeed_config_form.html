<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Autofeed Configuration Form</title>
  <style>
    body {
      background: #f3f6fa;
      min-height: 100vh;
      padding: 20px;
      font-family: Arial, Helvetica, sans-serif;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: #fff;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
      border-radius: 18px;
      padding: 30px 40px;
      margin-bottom: 30px;
    }
    
    .card-header {
      text-align: center;
      margin-bottom: 30px;
      color: #2a3b4c;
      font-size: 32px;
      font-weight: 600;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #2a3b4c;
      margin: 25px 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e3eaf2;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-field {
      display: flex;
      flex-direction: column;
    }
    
    .form-field label {
      font-weight: 600;
      color: #2a3b4c;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    .form-field input,
    .form-field select {
      padding: 8px 12px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 14px;
      background: #f8fafc;
    }
    
    .form-field input:focus,
    .form-field select:focus {
      outline: none;
      border-color: #3b82f6;
      background: #fff;
    }
    
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .pump-config {
      background: #f8fafc;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .pump-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 15px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #f8fafc;
      border-radius: 10px;
      overflow: hidden;
    }
    
    th, td {
      border: 1px solid #e0e6ed;
      padding: 8px 12px;
      text-align: center;
    }
    
    th {
      background: #e3eaf2;
      color: #2a3b4c;
      font-weight: 600;
      font-size: 14px;
    }
    
    table tbody td:first-child {
      font-size: 13px;
      font-weight: 500;
    }
    
    table tbody td:nth-child(2),
    table tbody td:nth-child(3),
    table tbody td:nth-child(4) {
      text-align: left;
      padding-left: 20px;
      position: relative;
    }
    
    table td input[type="number"] {
      width: 90px;
      border: 1px solid #7a7a7a;
      border-radius: 4px;
      padding: 4px 8px;
    }
    
    .plus24-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      font-size: 11px;
      border: 1px solid #0e1d36;
      background: #3b82f6;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .plus24-btn:hover {
      background: #2563eb;
    }
    
    .plus24-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .submit-btn {
      display: block;
      margin: 30px auto;
      padding: 12px 48px;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 4px 12px rgba(59,130,246,0.3);
    }
    
    .submit-btn:hover {
      background: #2563eb;
    }
    
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    
    .card-footer {
      text-align: center;
      font-size: 12px;
      color: #6b7280;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #e0e6ed;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="card-header">
        Autofeed Configuration Form v5.3
      </div>
      
      <form id="configForm" autocomplete="off">
        <!-- Experiment Info Section -->
        <div class="section-title">Experiment Information</div>
        <div class="form-grid">
          <div class="form-field">
            <label for="userName">User Name:</label>
            <input type="text" id="userName" placeholder="e.g. Colin Larsson" required>
          </div>
          <div class="form-field">
            <label for="experimentId">Experiment ID:</label>
            <input type="text" id="experimentId" placeholder="e.g. 706R020725" required>
          </div>
          <div class="form-field">
            <label for="reactorId">Reactor ID:</label>
            <input type="text" id="reactorId" placeholder="e.g. H1-4" required>
          </div>
          <div class="form-field">
            <label for="sampleDelay">Sample Delay (hours):</label>
            <input type="number" step="any" id="sampleDelay" value="4" required>
            <span class="help-text">Hours before feed to allow sample confirmation</span>
          </div>
        </div>
        
        <!-- Pump Configuration Section -->
        <div class="section-title">Pump Configuration</div>
        
        <div class="pump-config">
          <div style="font-weight: 600; margin-bottom: 10px;">Feed A (Major Feed) - Gravimetric</div>
          <div class="pump-config-grid">
            <div class="form-field">
              <label for="feedAPump">Pump Assignment:</label>
              <select id="feedAPump" required>
                <option value="A">Pump A</option>
                <option value="B">Pump B</option>
                <option value="C">Pump C</option>
                <option value="D" selected>Pump D</option>
                <option value="E">Pump E</option>
                <option value="F">Pump F</option>
              </select>
            </div>
            <div class="form-field">
              <label for="feedAFCal">F-Calibration:</label>
              <input type="number" step="any" id="feedAFCal" value="15.92" required>
            </div>
            <div class="form-field">
              <label for="feedAFlowRate">Flow Rate (mL/h):</label>
              <input type="number" step="any" id="feedAFlowRate" value="250" required>
            </div>
          </div>
        </div>
        
        <div class="pump-config">
          <div style="font-weight: 600; margin-bottom: 10px;">Feed B - Volumetric</div>
          <div class="pump-config-grid">
            <div class="form-field">
              <label for="feedBPump">Pump Assignment:</label>
              <select id="feedBPump" required>
                <option value="A">Pump A</option>
                <option value="B">Pump B</option>
                <option value="C">Pump C</option>
                <option value="D">Pump D</option>
                <option value="E">Pump E</option>
                <option value="F" selected>Pump F</option>
              </select>
            </div>
            <div class="form-field">
              <label for="feedBFCal">F-Calibration:</label>
              <input type="number" step="any" id="feedBFCal" value="105" required>
            </div>
            <div class="form-field">
              <label for="feedBFlowRate">Flow Rate (mL/h):</label>
              <input type="number" step="any" id="feedBFlowRate" value="15" required>
            </div>
          </div>
        </div>
        
        <div class="pump-config">
          <div style="font-weight: 600; margin-bottom: 10px;">Glucose Feed - Gravimetric</div>
          <div class="pump-config-grid">
            <div class="form-field">
              <label for="glucosePump">Pump Assignment:</label>
              <select id="glucosePump" required>
                <option value="A">Pump A</option>
                <option value="B">Pump B</option>
                <option value="C">Pump C</option>
                <option value="D">Pump D</option>
                <option value="E" selected>Pump E</option>
                <option value="F">Pump F</option>
              </select>
            </div>
            <div class="form-field">
              <label for="glucoseFCal">F-Calibration:</label>
              <input type="number" step="any" id="glucoseFCal" value="24" required>
            </div>
            <div class="form-field">
              <label for="glucoseFlowRate">Flow Rate (mL/h):</label>
              <input type="number" step="any" id="glucoseFlowRate" value="150" required>
            </div>
          </div>
        </div>
        
        <!-- Feed Schedule Section -->
        <div class="section-title">Feed Schedule (14 Events)</div>
        <table>
          <thead>
            <tr>
              <th>Event</th>
              <th>Feed Time (hrs)</th>
              <th>Feed A (g)</th>
              <th>Feed B (mL)</th>
            </tr>
          </thead>
          <tbody id="scheduleTable"></tbody>
        </table>
        
        <button type="button" class="submit-btn" onclick="generateScript()">Generate Script</button>
      </form>
      
      <div class="card-footer">
        Colin Larsson — Autofeed Configuration Form v5.3
      </div>
    </div>
  </div>

  <script>
    // Default values
    const defaultFeedTimes = [24,48,72,96,120,144,168,192,216,240,264,288,312,336];
    const defaultFeedA = [0,45,0,90,0,120,0,150,0,150,0,0,0,0];
    const defaultFeedB = [0.0,1.5,0.0,3.0,0.0,4.5,0.0,6.0,0.0,7.5,0.0,0.0,0.0,0.0];

    // Build schedule table
    const tbody = document.getElementById('scheduleTable');
    for (let i = 1; i <= 14; i++) {
      const tr = document.createElement('tr');
      
      const tdEvent = document.createElement('td');
      tdEvent.textContent = `Feed #${i.toString().padStart(2,'0')}`;
      tr.appendChild(tdEvent);
      
      const tdTime = document.createElement('td');
      const inpTime = document.createElement('input');
      inpTime.type = 'number';
      inpTime.step = 'any';
      inpTime.id = `feedTime${i}`;
      inpTime.value = defaultFeedTimes[i-1];
      tdTime.appendChild(inpTime);
      
      if (i > 1) {
        const btnPlus = document.createElement('button');
        btnPlus.type = 'button';
        btnPlus.className = 'plus24-btn';
        btnPlus.innerHTML = `<span>+24</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>`;
        btnPlus.title = `Add 24hrs to Feed #${i-1} time`;
        btnPlus.addEventListener('click', () => {
          const prev = parseFloat(document.getElementById(`feedTime${i-1}`).value);
          inpTime.value = (isNaN(prev) ? 0 : prev) + 24;
        });
        tdTime.appendChild(btnPlus);
      }
      tr.appendChild(tdTime);
      
      const tdA = document.createElement('td');
      const inpA = document.createElement('input');
      inpA.type = 'number';
      inpA.step = 'any';
      inpA.id = `feedA${i}`;
      inpA.value = defaultFeedA[i-1];
      tdA.appendChild(inpA);
      tr.appendChild(tdA);
      
      const tdB = document.createElement('td');
      const inpB = document.createElement('input');
      inpB.type = 'number';
      inpB.step = 'any';
      inpB.id = `feedB${i}`;
      inpB.value = defaultFeedB[i-1];
      tdB.appendChild(inpB);
      tr.appendChild(tdB);
      
      tbody.appendChild(tr);
    }

    function generateScript() {
      // Gather form data
      const userName = document.getElementById('userName').value.trim();
      const experimentId = document.getElementById('experimentId').value.trim();
      const reactorId = document.getElementById('reactorId').value.trim();
      const sampleDelay = parseFloat(document.getElementById('sampleDelay').value);
      
      if (!userName || !experimentId || !reactorId || isNaN(sampleDelay)) {
        alert('Please complete all required fields.');
        return;
      }
      
      // Pump configurations
      const feedAPump = document.getElementById('feedAPump').value;
      const feedAFCal = parseFloat(document.getElementById('feedAFCal').value);
      const feedAFlowRate = parseFloat(document.getElementById('feedAFlowRate').value);
      
      const feedBPump = document.getElementById('feedBPump').value;
      const feedBFCal = parseFloat(document.getElementById('feedBFCal').value);
      const feedBFlowRate = parseFloat(document.getElementById('feedBFlowRate').value);
      
      const glucosePump = document.getElementById('glucosePump').value;
      const glucoseFCal = parseFloat(document.getElementById('glucoseFCal').value);
      const glucoseFlowRate = parseFloat(document.getElementById('glucoseFlowRate').value);
      
      // Gather schedule data
      const feedTimes = [];
      const feedAValues = [];
      const feedBValues = [];
      
      for (let i = 1; i <= 14; i++) {
        const time = parseFloat(document.getElementById(`feedTime${i}`).value);
        const valA = parseFloat(document.getElementById(`feedA${i}`).value);
        const valB = parseFloat(document.getElementById(`feedB${i}`).value);
        
        if ([time, valA, valB].some(v => isNaN(v))) {
          alert(`Invalid entry on Feed #${i}.`);
          return;
        }
        
        feedTimes.push(time);
        feedAValues.push(valA);
        feedBValues.push(valB);
      }
      
      // Generate VB script
      const script = generateVBScript({
        userName, experimentId, reactorId, sampleDelay,
        feedAPump, feedAFCal, feedAFlowRate,
        feedBPump, feedBFCal, feedBFlowRate,
        glucosePump, glucoseFCal, glucoseFlowRate,
        feedTimes, feedAValues, feedBValues
      });
      
      // Download file
      const blob = new Blob([script], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `${experimentId}_${reactorId}_Autofeed_v5.3.vb`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function generateVBScript(config) {
      const pumpProps = {
        A: { totalizer: 'VAPV', setpoint: 'FASP', active: 'pumpAActive', fcal: 'FACal', setPV: 'SetVAPV' },
        B: { totalizer: 'VBPV', setpoint: 'FBSP', active: 'pumpBActive', fcal: 'FBCal', setPV: 'SetVBPV' },
        C: { totalizer: 'VCPV', setpoint: 'FCSP', active: 'pumpCActive', fcal: 'FCCal', setPV: 'SetVCPV' },
        D: { totalizer: 'VDPV', setpoint: 'FDSP', active: 'pumpDActive', fcal: 'FDCal', setPV: 'SetVDPV' },
        E: { totalizer: 'VEPV', setpoint: 'FESP', active: 'pumpEActive', fcal: 'FECal', setPV: 'SetVEPV' },
        F: { totalizer: 'VFPV', setpoint: 'FFSP', active: 'pumpFActive', fcal: 'FFCal', setPV: 'SetVFPV' }
      };
      
      const feedA = pumpProps[config.feedAPump];
      const feedB = pumpProps[config.feedBPump];
      const glucose = pumpProps[config.glucosePump];
      
      const feedTimesStr = config.feedTimes.map((v, i) => `Feed_Time(${i+1}) = ${v}`).join('\n');
      const feedAStr = config.feedAValues.map((v, i) => `Major_Feed_TargetWeight_Value(${i+1}) = ${v}`).join('\n');
      const feedBStr = config.feedBValues.map((v, i) => `FeedB_VolumeTarget_Value(${i+1}) = ${v}`).join('\n');

      return `'Autofeed for Scivario - Generated Configuration
'Version 5.3 - Generated: ${new Date().toISOString().split('T')[0]}
'User: ${config.userName}
'Experiment: ${config.experimentId}
'Reactor: ${config.reactorId}

'=== PUMP CONFIGURATION ===
'Feed A (Major Feed): Pump ${config.feedAPump} - Gravimetric - FCal: ${config.feedAFCal}
'Feed B: Pump ${config.feedBPump} - Volumetric - FCal: ${config.feedBFCal}
'Glucose: Pump ${config.glucosePump} - Gravimetric - FCal: ${config.glucoseFCal}

'Feed Variables
Dim MajorFeed_Fed as Double '[g]
Dim glucoseFeed_Fed as Double '[g]

'BalanceState Function
Dim State As Integer = p.BalanceAState()

Dim Scale_Weight(6) as Double 
Scale_Weight(1) = p.MAPV 'time zero bottle weight 
Scale_Weight(2) = p.MAPV 'interval starting bottleweight 
Scale_Weight(3) = p.MAPV 'current weight feed A
Scale_Weight(4) = p.MAPV 'glucose interval starting bottleweight
Scale_Weight(5) = p.MAPV 'current weight glucose

'Process Day Calculation
Dim procDay As Integer
Dim calculatedProcDay As Integer
calculatedProcDay = int((p.inoculationTime_H + 8) / 24)

If calculatedProcDay < 0 Then
    procDay = 0
Else
    procDay = calculatedProcDay
End If

'Configuration Parameters
Dim sampleDelay as Double = ${config.sampleDelay}
Dim Feed_StartTime as Double = 0
Dim samplePromptLead_H As Double = 4

'Feed Schedule Arrays
Dim Feed_Time(15) as Double
${feedTimesStr}

Dim Major_Feed_TargetWeight as Double
Dim Major_Feed_TargetWeight_Value(15) as Double
${feedAStr}

Dim FeedB_VolumeTarget as Double = 0
Dim FeedB_VolumeTarget_Value(15) as Double
${feedBStr}

'Pump Calibrations
Dim FeedA_FCal as Double = ${config.feedAFCal}
Dim FeedB_FCal as Double = ${config.feedBFCal}
Dim Glucose_FCal as Double = ${config.glucoseFCal}

Dim MaxFeeds As Integer = 14

'Feed A SetPoints
Dim Major_Feed_SP as Double = ${config.feedAFlowRate}
Dim Major_Feed_Percent_Value as Double = 0.25
Dim Major_Feed_SP_percent as Double = Major_Feed_SP * Major_Feed_Percent_Value
Dim cut_pumpValue_Percent as Double = 0.75
Dim Major_Feed_Counter as Double = 0

'Glucose Feed SetPoints
Dim Glucose_Feed_SP as Double = ${config.glucoseFlowRate}
Dim Glucose_Feed_Percent_Value as Double = 0.25
Dim Glucose_Feed_SP_percent as Double = Glucose_Feed_SP * Glucose_Feed_Percent_Value
Dim Glucose_Cut_pumpValue_Percent as Double = 0.75

'Feed B Parameters
Dim FeedB_FlowRate as Double = ${config.feedBFlowRate}
Dim FeedB_Counter as Double = 0
Dim FeedB_Totalizer as Double = 0

'Initialize State Array
If s is Nothing then
    Dim a(22) as Double
    a(1) = 0  'time zero bottle weight
    a(2) = 0  'interval starting bottleweight
    a(3) = 0  'current weight
    a(4) = Major_Feed_TargetWeight
    a(5) = Major_Feed_Counter
    a(6) = Feed_StartTime
    a(7) = FeedB_Counter
    a(8) = FeedB_Totalizer
    a(9) = FeedB_VolumeTarget
    a(10) = 0 'Glucose interval starting bottleweight
    a(11) = 0 'current weight for glucose
    a(12) = 0 'user input glucose
    a(13) = 0 'Feed A totalizer baseline
    a(14) = 0 'Glucose totalizer baseline
    a(15) = 0 'Feed B totalizer baseline
    a(16) = 0 'Glucose and Sample Confirmation Flag
    s = a
End If

If P isNot Nothing Then
    With P
        'Calculate fed amounts
        MajorFeed_Fed = (s(2) - s(3))
        glucoseFeed_Fed = (s(10) - s(11))
        
        'Display variables
        .intU = .phase
        .intV = .runtime_H - .phaseStart_H
        .intC = s(5)  'Feed Counter
        .intD = procDay
        .intE = s(4)  'major feed target
        .intG = s(12) 'glucose target
        .intH = s(10) - s(11) 'glucose fed
        .intI = s(9) + s(8)   'feed b volume target
        .intJ = s(9)
        .intK = s(2)
        .intL = s(3)
        
        'Calculate time remaining
        Dim timeRemaining As Double
        If s(5) = 0 Then
            timeRemaining = Feed_Time(1) - .inoculationTime_H
        Else
            timeRemaining = s(6) - .inoculationTime_H
        End If
        
        .intT = If(timeRemaining < 0, 0, timeRemaining)
        
        Static lastState As Integer
        If State <> lastState Then
            Select Case State
                Case 0: .logalarm("████ Scale is inactive ████")
                Case 1: .logalarm("████ Scale is idle ████")
                Case 2: .logMessage("████ Scale is busy ████")
                Case 3: .logalarm("████ Scale is in manual mode ████")
                Case 4: .logalarm("████ Scale is calibrating... ████")
                Case 5: .logalarm("████ Scale has an error ████")
            End Select
            lastState = State
        End If
        
        Select Case .phase
            Case 0
                .logmessage("██████████ AUTOFEED v5.3 LAUNCHING... ██████████")
                .phase = .phase + 1
                
            Case 1
                If .InoculationTime_H > 0 And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                    .phase = .phase + 1
                End If
                
            Case 2
                .${feedA.active} = False
                .${feedB.active} = False
                .${glucose.active} = False
                
                s(16) = 0
                
                If .OfflineM = 0 Then
                    If .InoculationTime_H > Feed_Time(1) And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                        s(5) = s(5) + 1
                        s(7) = s(7) + 1
                        .phase = .phase + 1
                    ElseIf s(5) > MaxFeeds Then
                        .${feedA.active} = False
                        .${feedB.active} = False
                        .${glucose.active} = False
                        .logmessage("All Feeds Delivered. Stopping.")
                        .phase = 16
                    End If
                End If
                
            Case 3
                'Assign feed parameters based on counter
                If s(5) >= 1 And s(5) <= 14 Then
                    Feed_StartTime = Feed_Time(s(5))
                    Major_Feed_TargetWeight = Major_Feed_TargetWeight_Value(s(5))
                End If
                
                If s(7) >= 1 And s(7) <= 14 Then
                    FeedB_Totalizer = .${feedB.totalizer}
                    FeedB_VolumeTarget = FeedB_VolumeTarget_Value(s(7))
                End If
                
                s(4) = Major_Feed_TargetWeight
                s(6) = Feed_StartTime
                s(8) = FeedB_Totalizer
                s(9) = FeedB_VolumeTarget
                
                If .intB = 0 And .inoculationTime_H < (s(6) + sampleDelay) And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                    .logwarning("██ Phase 3 - Day " & procDay & " - Enter Glucose in intA, confirm in intB")
                    .intT = s(6) - .inoculationTime_H
                    .phase = .phase + 1
                ElseIf .intB = 1 And .inoculationTime_H > s(6) Then
                    .intT = s(6) - .inoculationTime_H
                    .logmessage("██ Phase 3 - Sample Confirmed - Next feed in " & formatNumber(.intT, 2) & " hrs")
                    .phase = .phase + 2
                End If
                
            Case 4
                s(12) = .intA
                If .intB = 0 And .inoculationTime_H > (s(6) + sampleDelay) Then
                    .logwarning("Phase 4: Sample not verified, feeding late")
                    .phase = .phase + 1
                ElseIf .intB = 1 And .inoculationTime_H > s(6) Then
                    .logmessage("██ Phase 4 - Sample Confirmed")
                    .phase = .phase + 1
                End If
                
            Case 5
                If (.runtime_H - .phaseStart_H) > 0.1/60 And .inoculationTime_H > s(6) And s(9) <> 0 Then
                    .logmessage("Phase 5 - Feed B Starting: " & s(9) & " mL")
                    .phase = .phase + 1
                ElseIf (.runtime_H - .phaseStart_H) > 0.1/60 And .inoculationTime_H > s(6) And s(9) <= 0 Then
                    .logmessage("Phase 5 - No Feed B, skipping")
                    .phase = .phase + 2
                End If
                
            Case 6
                If .inoculationTime_H > s(6) Then
                    .${feedB.active} = True
                End If
                
                If s(7) <= MaxFeeds Then
                    If .${feedB.totalizer} < s(8) + s(9) Then
                        .${feedB.setpoint} = FeedB_FlowRate
                    Else
                        .logmessage("██ Phase 6 - Feed B Finished: " & s(9) & " mL")
                        .phase = .phase + 1
                    End If
                ElseIf s(7) > MaxFeeds And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                    .phase = 16
                End If
                
            Case 7
                .${feedB.active} = False
                s(1) = Scale_Weight(1)
                
                If .inoculationTime_H > Feed_Time(14) Then
                    .phase = 2
                Else
                    .phase = .phase + 1
                End If
                
            Case 8
                s(13) = .${feedA.totalizer}
                s(2) = Scale_Weight(2)
                s(3) = s(2)
                
                If .inoculationTime_H > s(6) And s(4) <> 0 And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                    .phase = .phase + 1
                ElseIf s(4) = 0 Then
                    .logmessage("Phase 8 - No Feed A, skipping")
                    .phase = .phase + 2
                End If
                
            Case 9
                Dim FeedA_Fed_Totalizer As Double
                FeedA_Fed_Totalizer = .${feedA.totalizer} - s(13)
                
                s(3) = Scale_Weight(3)
                .intF = s(2) - s(3)
                .${feedA.active} = True
                
                If Abs(MajorFeed_Fed) > (s(4) * cut_pumpValue_Percent) Then
                    .${feedA.setpoint} = Major_Feed_SP_percent
                Else
                    .${feedA.setpoint} = Major_Feed_SP
                End If
                
                If Abs(MajorFeed_Fed) > s(4) And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                    .${feedA.active} = False
                    .intF = s(2) - s(3)
                    .logmessage("██ Phase 9 - Feed A Fed: " & formatNumber(MajorFeed_Fed, 2) & " g")
                    .phase = .phase + 1
                ElseIf (.runtime_H - .phaseStart_H) > 0.1/60 And FeedA_Fed_Totalizer > (1.1 * s(4)) Then
                    .${feedA.active} = False
                    .intF = FeedA_Fed_Totalizer
                    .logalarm("██ Phase 9 - Feed A Totalizer " & formatNumber(FeedA_Fed_Totalizer, 2) & " g exceeds 110% of target")
                    .phase = .phase + 1
                End If
                
                If .OfflineO = 2 Then
                    .phase = 2
                End If
                
            Case 10
                s(10) = Scale_Weight(4)
                s(11) = s(10)
                s(12) = .intA
                
                If .intB = 0 And .inoculationTime_H < (s(6) + sampleDelay) Then
                    .phase = .phase + 1
                ElseIf .intB = 1 Then
                    .phase = .phase + 2
                End If
                
            Case 11
                s(12) = .intA
                If .intB = 0 And .inoculationTime_H > (s(6) + sampleDelay) Then
                    .logwarning("██ Phase 11 - Skipping glucose, sample not verified")
                    .phase = .phase + 4
                ElseIf .intB = 1 Then
                    .phase = .phase + 1
                End If
                
            Case 12
                s(10) = Scale_Weight(4)
                s(11) = s(10)
                s(12) = .intA
                s(14) = .${glucose.totalizer}
                
                If .inoculationTime_H > s(6) And (.runtime_H - .phaseStart_H) > 0.5/60 Then
                    .phase = .phase + 1
                End If
                
            Case 13
                s(14) = .${glucose.totalizer}
                s(10) = Scale_Weight(4)
                s(11) = s(10)
                
                If s(12) = 0 And (.runtime_H - .phaseStart_H) > 0.5/60 Then
                    .logmessage("Phase 13 - No glucose to feed")
                    .phase = .phase + 2
                ElseIf s(12) <> 0 And (.runtime_H - .phaseStart_H) > 0.5/60 Then
                    .logmessage("Phase 13 - Glucose feed: " & s(12) & " g")
                    .phase = .phase + 1
                End If
                
            Case 14
                Dim Glucose_Fed_Totalizer As Double
                Glucose_Fed_Totalizer = .${glucose.totalizer} - s(14)
                
                s(11) = Scale_Weight(5)
                .intH = s(10) - s(11)
                .${glucose.active} = True
                
                If Abs(glucoseFeed_Fed) > (s(12) * Glucose_Cut_pumpValue_Percent) Then
                    .${glucose.setpoint} = Glucose_Feed_SP_percent
                Else
                    .${glucose.setpoint} = Glucose_Feed_SP
                End If
                
                If Abs(glucoseFeed_Fed) > s(12) And (.runtime_H - .phaseStart_H) > 0.1/60 Then
                    .logmessage("Phase 14 - Glucose fed: " & formatNumber(glucoseFeed_Fed, 2) & " g")
                    .phase = .phase + 1
                ElseIf (.runtime_H - .phaseStart_H) > 0.1/60 And Glucose_Fed_Totalizer > (1.1 * s(12)) Then
                    .${glucose.active} = False
                    .logwarning("██ Phase 14 - Glucose Totalizer " & formatNumber(Glucose_Fed_Totalizer, 2) & " g exceeds 110%")
                    .phase = .phase + 1
                End If
                
            Case 15
                .${glucose.active} = False
                
                If s(16) = 0 Then
                    .intA = 0
                    .intB = 0
                    s(16) = 1
                End If
                
                If .runtime_H - .phaseStart_H > 0.1/60 Then
                    .logwarning("██ Phase 15 - Day " & procDay & " - Feed A: " & formatNumber(MajorFeed_Fed, 2) & " g, Feed B: " & s(9) & " mL, Glucose: " & formatNumber(glucoseFeed_Fed, 2) & " g")
                    .phase = 2
                End If
                
            Case 16
                .${feedA.active} = False
                .${feedB.active} = False
                .${glucose.active} = False
                
        End Select
    End With
End If

'Debug logs (disable when not debugging)
'p.LogMessage("Phase: " & p.phase)
'p.LogMessage("Inoc Time [h]: " & p.InoculationTime_H)
'p.LogMessage("MajorFeed Fed: " & MajorFeed_Fed)
'p.LogMessage("Array s(2) - STATIC INTERVAL: " & s(2))
'p.LogMessage("Array s(3) - DYNAMIC INTERVAL: " & s(3))
'p.LogMessage("Array s(4) - TARGET: " & s(4))
'p.LogMessage("Array s(5) - COUNTER: " & s(5))
`;
    }
  </script>
</body>
</html>